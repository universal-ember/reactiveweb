{"version":3,"file":"remote-data.js","sources":["../src/remote-data.ts"],"sourcesContent":["import { tracked } from '@glimmer/tracking';\nimport { waitForPromise } from '@ember/test-waiters';\n\nimport { resource, resourceFactory } from 'ember-resources';\n\nimport type { ResourceAPI } from 'ember-resources';\n\ntype FetchOptions = Parameters<typeof fetch>[1];\n\n/**\n * @protected\n */\nexport class State<T = unknown> {\n  /**\n   * If an exception was thrown while making the request, the error\n   * thrown will be here.\n   */\n  @tracked error: Error | null = null;\n  /**\n   * The resolved value of the fetch request\n   */\n  @tracked value: T | null = null;\n\n  /**\n   * HTTP status code.\n   */\n  @tracked status: null | number = null;\n\n  /**\n   * True if the request has succeeded\n   */\n  @tracked isResolved = false;\n\n  /**\n   * True if the request has failed\n   */\n  @tracked isRejected = false;\n\n  /**\n   * true if the request has finished\n   */\n  get isFinished() {\n    return this.isResolved || this.isRejected;\n  }\n\n  /**\n   * Alias for `isFinished`\n   * which is in turn an alias for `isResolved || isRejected`\n   */\n  get isSettled() {\n    return this.isFinished;\n  }\n\n  /**\n   * Alias for isLoading\n   */\n  get isPending() {\n    return this.isLoading;\n  }\n\n  /**\n   * true if the fetch request is in progress\n   */\n  get isLoading() {\n    return !this.isFinished;\n  }\n\n  /**\n   * true if the request throws an exception\n   * or if the request.status is >= 400\n   */\n  get isError() {\n    let httpError = this.status && this.status >= 400;\n    let promiseThrew = this.isRejected;\n\n    return httpError || promiseThrew;\n  }\n}\n\n/**\n * Native [fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)\n * but with built-in [AbortController](https://developer.mozilla.org/en-US/docs/Web/API/AbortController)\n *\n * example with composition (maybe you want to implement your own version\n * that also wraps up authorization headers):\n * ```js\n * import { tracked } from '@glimmer/tracking';\n * import { use, resource } from 'ember-resources';\n * import { remoteData } from 'reactiveweb/remote-data';\n *\n * class Demo {\n *   @tracked id = 1;\n *\n *   @use myData = resource((hooks) =>\n *     remoteData(hooks, `https://...${this.id}`)\n *   );\n * }\n * ```\n *\n * The same example, but without `@use`\n *\n * ```js\n * import { tracked } from '@glimmer/tracking';\n * import { resource } from 'ember-resources';\n * import { remoteData } from 'reactiveweb/remote-data';\n *\n * class Demo {\n *   @tracked id = 1;\n *\n *   myData = resource(this, (hooks) =>\n *     remoteData(hooks, `https://...${this.id}`)\n *   );\n * }\n * ```\n *\n */\nexport function remoteData<T = unknown>(\n  { on }: ResourceAPI,\n  url: string,\n  options: FetchOptions = {}\n): State<T> {\n  let state = new State<T>();\n  let controller = new AbortController();\n\n  on.cleanup(() => controller.abort());\n\n  waitForPromise(\n    fetch(url, { signal: controller.signal, ...options })\n      .then((response) => {\n        state.status = response.status;\n\n        if (response.headers.get('Content-Type')?.includes('json')) {\n          return response.json();\n        }\n\n        return response.text();\n      })\n      .then((data) => {\n        state.isResolved = true;\n        state.value = data;\n      })\n      .catch((error) => {\n        state.isRejected = true;\n        state.error = error;\n      })\n  );\n\n  return state;\n}\n\n/**\n * json-based remote data utility.\n *\n * this API mimics the API of `fetch`, and will give you a reactive\n * [[State]] object, but won't be able to re-fetch when the url or options\n * change\n *\n * ```js\n * import { tracked } from '@glimmer/tracking';\n * import { use } from 'ember-resources';\n * import { RemoteData } from 'reactiveweb/remote-data';\n *\n * class Demo {\n *   @use myData = RemoteData(`https://some.domain.io`);\n *\n *   @use withOptions = RemoteData(`https://some.domain.io`, {\n *     headers: {\n *       Authorization: 'Bearer <token>'\n *     }\n *   });\n * }\n * ```\n *\n * In strict mode with &lt;template&gt;\n * ```jsx gjs\n * import { RemoteData } from 'reactiveweb/remote-data';\n *\n * const options = (token) => ({\n *   headers: {\n *     Authorization: `Bearer ${token}`\n *   }\n * });\n *\n * <template>\n *  {{#let (RemoteData \"https://some.domain\" (options \"my-token\")) as |state|}}\n *    {{state.isLoading}}\n *    {{state.value}}\n *  {{/let}}\n * </template>\n * ```\n *\n */\nexport function RemoteData<T = unknown>(url: string, options?: FetchOptions): State<T>;\n\n/**\n * json-based remote data utility\n *\n *\n * For a reactive URL (causing the underlying fetch to re-run when the URL changes),\n * the url must be the return value from a function passed to\n * `RemoteData`.\n *\n * ```js\n * import { tracked } from '@glimmer/tracking';\n * import { use } from 'ember-resources';\n * import { RemoteData } from 'reactiveweb/remote-data';\n *\n * class Demo {\n *   @tracked url = 'https:// .... '\n *\n *   @use myData = RemoteData(() => this.url);\n * }\n * ```\n */\nexport function RemoteData<T = unknown>(url: () => string): State<T>;\n\n/**\n * json-based remote data utility\n *\n * When you want the remote data request to re-fetch\n * when either the URL or `FetchOptions` change, the `url`\n * becomes a property on the object returned from the thunk.\n *\n * ```js\n * import { tracked } from '@glimmer/tracking';\n * import { use } from 'ember-resources';\n * import { RemoteData } from 'reactiveweb/remote-data';\n *\n * class Demo {\n *   @tracked id = 2;\n *   @tracked postData = '';\n *\n *   @use myData = RemoteData(() => ({\n *     url: `https://this.some.domain/${this.id}`,\n *     method: 'POST',\n *     body: this.postData\n *   }));\n * }\n * ```\n */\nexport function RemoteData<T = unknown>(options: () => { url: string } & FetchOptions): State<T>;\n\n/**\n * json-based remote data utility\n */\nexport function RemoteData<T = unknown>(\n  url: string | (() => string) | (() => { url: string } & FetchOptions),\n  opts?: FetchOptions\n) {\n  return resource((hooks) => {\n    let result = typeof url === 'string' ? url : url();\n    let targetUrl: string;\n    let options: FetchOptions = {};\n\n    if (typeof result === 'string') {\n      targetUrl = result;\n    } else {\n      let { url, ...opts } = result;\n\n      targetUrl = url;\n      options = opts;\n    }\n\n    if (opts) {\n      options = { ...options, ...opts };\n    }\n\n    return remoteData<T>(hooks, targetUrl, options);\n  });\n}\n\nresourceFactory(RemoteData);\n"],"names":["State","g","this","prototype","tracked","i","void 0","isFinished","isResolved","isRejected","isSettled","isPending","isLoading","isError","httpError","status","promiseThrew","remoteData","on","url","options","state","controller","AbortController","cleanup","abort","waitForPromise","fetch","signal","then","response","headers","get","includes","json","text","data","value","catch","error","RemoteData","opts","resource","hooks","result","targetUrl","resourceFactory"],"mappings":"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"}