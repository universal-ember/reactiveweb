{"version":3,"file":"remote-data.js","sources":["../src/remote-data.ts"],"sourcesContent":["import { tracked } from '@glimmer/tracking';\nimport { waitForPromise } from '@ember/test-waiters';\n\nimport { resource, resourceFactory } from 'ember-resources';\n\nimport type { ResourceAPI } from 'ember-resources';\n\ntype FetchOptions = Parameters<typeof fetch>[1];\n\n/**\n * @protected\n */\nexport class State<T = unknown> {\n  /**\n   * If an exception was thrown while making the request, the error\n   * thrown will be here.\n   */\n  @tracked error: Error | null = null;\n  /**\n   * The resolved value of the fetch request\n   */\n  @tracked value: T | null = null;\n\n  /**\n   * HTTP status code.\n   */\n  @tracked status: null | number = null;\n\n  /**\n   * True if the request has succeeded\n   */\n  @tracked isResolved = false;\n\n  /**\n   * True if the request has failed\n   */\n  @tracked isRejected = false;\n\n  /**\n   * true if the request has finished\n   */\n  get isFinished() {\n    return this.isResolved || this.isRejected;\n  }\n\n  /**\n   * Alias for `isFinished`\n   * which is in turn an alias for `isResolved || isRejected`\n   */\n  get isSettled() {\n    return this.isFinished;\n  }\n\n  /**\n   * Alias for isLoading\n   */\n  get isPending() {\n    return this.isLoading;\n  }\n\n  /**\n   * true if the fetch request is in progress\n   */\n  get isLoading() {\n    return !this.isFinished;\n  }\n\n  /**\n   * true if the request throws an exception\n   * or if the request.status is >= 400\n   */\n  get isError() {\n    const httpError = this.status && this.status >= 400;\n    const promiseThrew = this.isRejected;\n\n    return httpError || promiseThrew;\n  }\n}\n\n/**\n * Native [fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)\n * but with built-in [AbortController](https://developer.mozilla.org/en-US/docs/Web/API/AbortController)\n *\n * example with composition (maybe you want to implement your own version\n * that also wraps up authorization headers):\n * ```js\n * import { tracked } from '@glimmer/tracking';\n * import { use, resource } from 'ember-resources';\n * import { remoteData } from 'reactiveweb/remote-data';\n *\n * class Demo {\n *   @tracked id = 1;\n *\n *   @use myData = resource((hooks) =>\n *     remoteData(hooks, `https://...${this.id}`)\n *   );\n * }\n * ```\n *\n * The same example, but without `@use`\n *\n * ```js\n * import { tracked } from '@glimmer/tracking';\n * import { resource } from 'ember-resources';\n * import { remoteData } from 'reactiveweb/remote-data';\n *\n * class Demo {\n *   @tracked id = 1;\n *\n *   myData = resource(this, (hooks) =>\n *     remoteData(hooks, `https://...${this.id}`)\n *   );\n * }\n * ```\n *\n */\nexport function remoteData<T = unknown>(\n  { on }: ResourceAPI,\n  url: string,\n  options: FetchOptions = {}\n): State<T> {\n  const state = new State<T>();\n  const controller = new AbortController();\n\n  on.cleanup(() => controller.abort());\n\n  waitForPromise(\n    fetch(url, { signal: controller.signal, ...options })\n      .then((response) => {\n        state.status = response.status;\n\n        if (response.headers.get('Content-Type')?.includes('json')) {\n          return response.json();\n        }\n\n        return response.text();\n      })\n      .then((data) => {\n        state.isResolved = true;\n        state.value = data;\n      })\n      .catch((error) => {\n        state.isRejected = true;\n        state.error = error;\n      })\n  );\n\n  return state;\n}\n\n/**\n * json-based remote data utility.\n *\n * this API mimics the API of `fetch`, and will give you a reactive\n * [[State]] object, but won't be able to re-fetch when the url or options\n * change\n *\n * ```js\n * import { tracked } from '@glimmer/tracking';\n * import { use } from 'ember-resources';\n * import { RemoteData } from 'reactiveweb/remote-data';\n *\n * class Demo {\n *   @use myData = RemoteData(`https://some.domain.io`);\n *\n *   @use withOptions = RemoteData(`https://some.domain.io`, {\n *     headers: {\n *       Authorization: 'Bearer <token>'\n *     }\n *   });\n * }\n * ```\n *\n * In strict mode with &lt;template&gt;\n * ```jsx gjs\n * import { RemoteData } from 'reactiveweb/remote-data';\n *\n * const options = (token) => ({\n *   headers: {\n *     Authorization: `Bearer ${token}`\n *   }\n * });\n *\n * <template>\n *  {{#let (RemoteData \"https://some.domain\" (options \"my-token\")) as |state|}}\n *    {{state.isLoading}}\n *    {{state.value}}\n *  {{/let}}\n * </template>\n * ```\n *\n */\nexport function RemoteData<T = unknown>(url: string, options?: FetchOptions): State<T>;\n\n/**\n * json-based remote data utility\n *\n *\n * For a reactive URL (causing the underlying fetch to re-run when the URL changes),\n * the url must be the return value from a function passed to\n * `RemoteData`.\n *\n * ```js\n * import { tracked } from '@glimmer/tracking';\n * import { use } from 'ember-resources';\n * import { RemoteData } from 'reactiveweb/remote-data';\n *\n * class Demo {\n *   @tracked url = 'https:// .... '\n *\n *   @use myData = RemoteData(() => this.url);\n * }\n * ```\n */\nexport function RemoteData<T = unknown>(url: () => string): State<T>;\n\n/**\n * json-based remote data utility\n *\n * When you want the remote data request to re-fetch\n * when either the URL or `FetchOptions` change, the `url`\n * becomes a property on the object returned from the thunk.\n *\n * ```js\n * import { tracked } from '@glimmer/tracking';\n * import { use } from 'ember-resources';\n * import { RemoteData } from 'reactiveweb/remote-data';\n *\n * class Demo {\n *   @tracked id = 2;\n *   @tracked postData = '';\n *\n *   @use myData = RemoteData(() => ({\n *     url: `https://this.some.domain/${this.id}`,\n *     method: 'POST',\n *     body: this.postData\n *   }));\n * }\n * ```\n */\nexport function RemoteData<T = unknown>(options: () => { url: string } & FetchOptions): State<T>;\n\n/**\n * json-based remote data utility\n */\nexport function RemoteData<T = unknown>(\n  url: string | (() => string) | (() => { url: string } & FetchOptions),\n  opts?: FetchOptions\n) {\n  return resource((hooks) => {\n    const result = typeof url === 'string' ? url : url();\n    let targetUrl: string;\n    let options: FetchOptions = {};\n\n    if (typeof result === 'string') {\n      targetUrl = result;\n    } else {\n      const { url, ...opts } = result;\n\n      targetUrl = url;\n      options = opts;\n    }\n\n    if (opts) {\n      options = { ...options, ...opts };\n    }\n\n    return remoteData<T>(hooks, targetUrl, options);\n  });\n}\n\nresourceFactory(RemoteData);\n"],"names":["State","g","prototype","tracked","i","void 0","isFinished","isResolved","isRejected","isSettled","isPending","isLoading","isError","httpError","status","promiseThrew","remoteData","on","url","options","state","controller","AbortController","cleanup","abort","waitForPromise","fetch","signal","then","response","headers","get","includes","json","text","data","value","catch","error","RemoteData","opts","resource","hooks","result","targetUrl","resourceFactory"],"mappings":"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"}