{"version":3,"file":"document-head.js","sources":["../src/document-head.ts"],"sourcesContent":["/**\n * Inspired from: https://github.com/hupe1980/react-script-hook/blob/master/src/use-script.tsx\n */\nimport { warn } from '@ember/debug';\nimport { waitForPromise } from '@ember/test-waiters';\n\nimport { resource, resourceFactory } from 'ember-resources';\n\n/**\n * Adds a `<script>` element to the document head.\n * Removed when the rendering context is torn down.\n *\n * No-ops if something else already added the script with the same URL.\n *\n * @example\n * ```js\n * import { addScript } from 'reactiveweb/document-head';\n *\n * <template>\n *  {{addScript \"https://my.cdn.com/asset/v1.2.3/file/path.js\"}}\n * </template>\n * ```\n */\nexport function addScript(\n  url: string | (() => string),\n  attributes?: undefined | (HTMLScriptElement & {})\n) {\n  let resolvedURL = typeof url === 'function' ? url() : url;\n\n  return resource(({ on }) => {\n    const existing = document.querySelector(`script[src=\"${resolvedURL}\"]`);\n\n    // Nothing to do, something else is managing this script\n    if (existing) {\n      warn(\n        `Something else added a <script> tag with the URL: ${url} to the page. Early exiiting. Will not cleanup.`,\n        {\n          id: 'reactiveweb/document-head#addScript',\n        }\n      );\n\n      return;\n    }\n\n    let el = document.createElement('script');\n    let resolve: (x?: unknown) => void;\n    let reject: (reason: unknown) => void;\n    let promise = new Promise((r, e) => {\n      resolve = r;\n      reject = e;\n    });\n\n    waitForPromise(promise);\n\n    Object.assign(el, {\n      ...attributes,\n      src: resolvedURL,\n      onload: (event: Event) => {\n        resolve();\n\n        if (typeof attributes?.onload === 'function') {\n          attributes.onload(event);\n        }\n      },\n      onerror: (reason: string | Event) => {\n        reject(reason);\n\n        if (typeof attributes?.onerror === 'function') {\n          attributes.onerror(reason);\n        }\n      },\n    });\n\n    document.head.appendChild(el);\n\n    on.cleanup(() => {\n      el.remove();\n      resolve();\n    });\n\n    /**\n     * We must return nothing so that nothing renders.\n     * (helpers and resources have their return value rendered, but undefined is \"nothing\")\n     */\n    return;\n  });\n}\n\nresourceFactory(addScript);\n\n/**\n * Adds a `<link>` element to the document head.\n * Removed when the rendering context is torn down.\n *\n * No-ops if something else already added the link with the same URL.\n *\n * @example\n * ```js\n * import { addLink } from 'reactiveweb/document-head';\n *\n * <template>\n *  {{addLink \"https://my.cdn.com/asset/v1.2.3/file/path.css\"}}\n * </template>\n * ```\n */\nexport function addLink(\n  url: string | (() => string),\n  attributes?: undefined | (HTMLLinkElement & {})\n) {\n  let resolvedURL = typeof url === 'function' ? url() : url;\n\n  return resource(({ on }) => {\n    const existing = document.querySelector(`link[href=\"${resolvedURL}\"]`);\n\n    // Nothing to do, something else is managing this script\n    if (existing) {\n      warn(\n        `Something else added a <link> tag with the URL: ${url} to the page. Early exiiting. Will not cleanup.`,\n        {\n          id: 'reactiveweb/document-addLink',\n        }\n      );\n\n      return;\n    }\n\n    let el = document.createElement('link');\n    let resolve: (x?: unknown) => void;\n    let reject: (reason: unknown) => void;\n    let promise = new Promise((r, e) => {\n      resolve = r;\n      reject = e;\n    });\n\n    waitForPromise(promise);\n\n    Object.assign(el, {\n      rel: 'stylesheet',\n      href: resolvedURL,\n      ...attributes,\n      onload: (event: Event) => {\n        resolve();\n\n        if (typeof attributes?.onload === 'function') {\n          attributes.onload(event);\n        }\n      },\n      onerror: (reason: string | Event) => {\n        reject(reason);\n\n        if (typeof attributes?.onerror === 'function') {\n          attributes.onerror(reason);\n        }\n\n        return true;\n      },\n    });\n\n    document.head.appendChild(el);\n\n    on.cleanup(() => {\n      el.remove();\n      resolve();\n    });\n\n    /**\n     * We must return nothing so that nothing renders.\n     * (helpers and resources have their return value rendered, but undefined is \"nothing\")\n     */\n    return;\n  });\n}\n\nresourceFactory(addLink);\n"],"names":["addScript","url","attributes","resolvedURL","resource","on","existing","document","querySelector","warn","id","el","createElement","resolve","reject","promise","Promise","r","e","waitForPromise","Object","assign","src","onload","event","onerror","reason","head","appendChild","cleanup","remove","resourceFactory","addLink","rel","href"],"mappings":"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"}