{"version":3,"file":"manager.js","sources":["../../../src/resource/modifier/manager.ts"],"sourcesContent":["import { getValue } from '@glimmer/tracking/primitives/cache';\nimport { destroy } from '@ember/destroyable';\nimport { invokeHelper } from '@ember/helper';\nimport { capabilities } from '@ember/modifier';\n\ninterface ArgsWrapper {\n  positional?: readonly unknown[];\n  named?: Record<string, any>;\n}\n\nimport { compatOwner } from '../../-private/ember-compat.ts';\n\nimport type { FunctionBasedModifierDefinition } from './index.ts';\nimport type Owner from '@ember/owner';\nimport type { ElementFor } from '#types';\n\ninterface State<S> {\n  instance: FunctionBasedModifierDefinition<S>;\n  helper: ReturnType<typeof invokeHelper> | null;\n}\n\ninterface CreatedState<S> extends State<S> {\n  element: null;\n}\n\ninterface InstalledState<S> extends State<S> {\n  element: ElementFor<S>;\n}\n\n// Wraps the unsafe (b/c it mutates, rather than creating new state) code that\n// TS does not yet understand.\nfunction installElement<S>(state: CreatedState<S>, element: ElementFor<S>): InstalledState<S> {\n  // SAFETY: this cast represents how we are actually handling the state machine\n  // transition: from this point forward in the lifecycle of the modifier, it\n  // always behaves as `InstalledState<S>`. It is safe because, and *only*\n  // because, we immediately initialize `element`. (We cannot create a new state\n  // from the old one because the modifier manager API expects mutation of a\n  // single state bucket rather than updating it at hook calls.)\n  const installedState = state as State<S> as InstalledState<S>;\n\n  installedState.element = element;\n\n  return installedState;\n}\n\nfunction arrangeArgs(element: Element, args: any) {\n  const { positional, named } = args;\n\n  const flattenedArgs = [element, ...positional];\n\n  if (Object.keys(named).length > 0) {\n    flattenedArgs.push(named);\n  }\n\n  return flattenedArgs;\n}\n\nexport default class FunctionBasedModifierManager<S> {\n  capabilities = capabilities('3.22');\n\n  constructor(owner: Owner) {\n    compatOwner.setOwner(this, owner);\n  }\n\n  createModifier(instance: FunctionBasedModifierDefinition<S>): CreatedState<S> {\n    return { element: null, instance, helper: null };\n  }\n\n  installModifier(createdState: CreatedState<S>, element: ElementFor<S>, args: ArgsWrapper): void {\n    const state = installElement(createdState, element);\n\n    compatOwner.linkOwner(state, this);\n\n    this.updateModifier(state, args);\n  }\n\n  updateModifier(state: InstalledState<S>, args: ArgsWrapper): void {\n    if (state.helper) {\n      destroy(state.helper);\n    }\n\n    state.helper = invokeHelper(this, state.instance, () => {\n      const foo = arrangeArgs(state.element, args);\n\n      return { positional: foo };\n    });\n\n    getValue(state.helper);\n  }\n\n  destroyModifier(state: InstalledState<S>): void {\n    if (state.helper) {\n      destroy(state.helper);\n    }\n  }\n}\n"],"names":["installElement","state","element","installedState","arrangeArgs","args","positional","named","flattenedArgs","Object","keys","length","push","FunctionBasedModifierManager","capabilities","constructor","owner","compatOwner","setOwner","createModifier","instance","helper","installModifier","createdState","linkOwner","updateModifier","destroy","invokeHelper","foo","getValue","destroyModifier"],"mappings":";;;;;;AA6BA;AACA;AACA,SAASA,cAAcA,CAAIC,KAAsB,EAAEC,OAAsB,EAAqB;AAC5F;AACA;AACA;AACA;AACA;AACA;EACA,MAAMC,cAAc,GAAGF,KAAsC;EAE7DE,cAAc,CAACD,OAAO,GAAGA,OAAO;AAEhC,EAAA,OAAOC,cAAc;AACvB;AAEA,SAASC,WAAWA,CAACF,OAAgB,EAAEG,IAAS,EAAE;EAChD,MAAM;IAAEC,UAAU;AAAEC,IAAAA;AAAM,GAAC,GAAGF,IAAI;AAElC,EAAA,MAAMG,aAAa,GAAG,CAACN,OAAO,EAAE,GAAGI,UAAU,CAAC;EAE9C,IAAIG,MAAM,CAACC,IAAI,CAACH,KAAK,CAAC,CAACI,MAAM,GAAG,CAAC,EAAE;AACjCH,IAAAA,aAAa,CAACI,IAAI,CAACL,KAAK,CAAC;AAC3B,EAAA;AAEA,EAAA,OAAOC,aAAa;AACtB;AAEe,MAAMK,4BAA4B,CAAI;AACnDC,EAAAA,YAAY,GAAGA,YAAY,CAAC,MAAM,CAAC;EAEnCC,WAAWA,CAACC,KAAY,EAAE;AACxBC,IAAAA,WAAW,CAACC,QAAQ,CAAC,IAAI,EAAEF,KAAK,CAAC;AACnC,EAAA;EAEAG,cAAcA,CAACC,QAA4C,EAAmB;IAC5E,OAAO;AAAElB,MAAAA,OAAO,EAAE,IAAI;MAAEkB,QAAQ;AAAEC,MAAAA,MAAM,EAAE;KAAM;AAClD,EAAA;AAEAC,EAAAA,eAAeA,CAACC,YAA6B,EAAErB,OAAsB,EAAEG,IAAiB,EAAQ;AAC9F,IAAA,MAAMJ,KAAK,GAAGD,cAAc,CAACuB,YAAY,EAAErB,OAAO,CAAC;AAEnDe,IAAAA,WAAW,CAACO,SAAS,CAACvB,KAAK,EAAE,IAAI,CAAC;AAElC,IAAA,IAAI,CAACwB,cAAc,CAACxB,KAAK,EAAEI,IAAI,CAAC;AAClC,EAAA;AAEAoB,EAAAA,cAAcA,CAACxB,KAAwB,EAAEI,IAAiB,EAAQ;IAChE,IAAIJ,KAAK,CAACoB,MAAM,EAAE;AAChBK,MAAAA,OAAO,CAACzB,KAAK,CAACoB,MAAM,CAAC;AACvB,IAAA;IAEApB,KAAK,CAACoB,MAAM,GAAGM,YAAY,CAAC,IAAI,EAAE1B,KAAK,CAACmB,QAAQ,EAAE,MAAM;MACtD,MAAMQ,GAAG,GAAGxB,WAAW,CAACH,KAAK,CAACC,OAAO,EAAEG,IAAI,CAAC;MAE5C,OAAO;AAAEC,QAAAA,UAAU,EAAEsB;OAAK;AAC5B,IAAA,CAAC,CAAC;AAEFC,IAAAA,QAAQ,CAAC5B,KAAK,CAACoB,MAAM,CAAC;AACxB,EAAA;EAEAS,eAAeA,CAAC7B,KAAwB,EAAQ;IAC9C,IAAIA,KAAK,CAACoB,MAAM,EAAE;AAChBK,MAAAA,OAAO,CAACzB,KAAK,CAACoB,MAAM,CAAC;AACvB,IAAA;AACF,EAAA;AACF;;;;"}