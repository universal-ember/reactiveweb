{"version":3,"file":"service.js","sources":["../../src/resource/service.ts"],"sourcesContent":["import { getValue } from '@glimmer/tracking/primitives/cache';\nimport { assert } from '@ember/debug';\nimport { associateDestroyableChild } from '@ember/destroyable';\nimport { invokeHelper } from '@ember/helper';\nimport { isDevelopingApp, isTesting, macroCondition } from '@embroider/macros';\n\nimport { compatOwner } from '../-private/ember-compat.ts';\n\nimport type Owner from '@ember/owner';\nimport type { Stage1DecoratorDescriptor } from '#types';\n\nconst getOwner = compatOwner.getOwner;\n\n/**\n * In order for the same cache to be used for all references\n * in an app, this variable needs to be in module scope.\n *\n * When the owner is destroyed, the cache is cleared\n * (because the WeakMap will see that nothing is referencing the key (owner) anymore)\n *\n * @internal\n */\nexport const __secret_service_cache__ = new WeakMap<Owner, Map<object, any>>();\n\n/**\n * For testing purposes, this allows us to replace a service with a \"mock\".\n */\nconst REPLACEMENTS = new WeakMap<Owner, Map<object, object>>();\n\n/**\n * <div class=\"callout note\">\n *\n * This is not a core part of ember-resources, but demonstrates how services *are* an extension of resources.  This utility should be considered a prototype, but this utility is still under the broader library's SemVer policy.\n *\n * A consuming app will not pay for the bytes of this utility unless imported.\n *\n * </div>\n *\n * An alternative to Ember's built in `@service` decorator.\n *\n * This decorator takes a resource and ties the resource's lifeime to the app / owner.\n *\n * The reason a resource is required, as opposed to allowing \"any class\", is that a\n * resource already has implemented the concept of \"teardown\" or \"cleanup\",\n * and native classes do not have this concept.\n *\n * Example:\n *\n * ```js\n * import Component from '@glimmer/component';\n * import { resource } from 'ember-resources';\n * import { service } from 'reactiveweb/resource/service';\n *\n * class PlanetsAPI { ... }\n *\n * const Planets = resource(({ on, owner }) => {\n *   let api = new PlanetsAPI(owner); // for further injections\n *\n *   // on cleanup, we want to cancel any pending requests\n *   on.cleanup(() => api.abortAll());\n *\n *   return api;\n * });\n *\n * class Demo extends Component {\n *   @service(Planets) planets;\n * }\n * ```\n *\n * For Stage 1 decorators and typescript, you'll need to manually declare the type:\n * ```ts\n * class Demo extends Component {\n *   @service(Planets) declare planets: Planets;\n * }\n * ```\n */\nexport function service(resource: unknown) {\n  /**\n   * In order for resources to be instantiated this way, we need to copy a little bit of code from\n   * `@use`, as we still need to rely on `invokeHelper`.\n   *\n   * The main difference being that instead of using `this` for the parent to `invokeHelper`,\n   * we use the owner.\n   *\n   * BIG NOTE RELATED TO TYPE SAFETY:\n   *  - the `resource` argument is typed as `unknown` because the user-land types\n   *    are lies so that DX is useful. The actual internal representation of a resource is an object\n   *    with some properties with some hints for type narrowing\n   */\n\n  // Deliberately separate comment so the above dev-comment doesn't make its way to\n  // consumers\n  // PropertyDecorator\n  return function legacyServiceDecorator(\n    _prototype: object,\n    key: string,\n    descriptor?: Stage1DecoratorDescriptor\n  ) {\n    if (!descriptor) return;\n\n    assert(`@service(...) can only be used with string-keys`, typeof key === 'string');\n\n    assert(\n      `@service(...) may not be used with an initializer. For example, ` +\n        `\\`@service(MyService) property;\\``,\n      !descriptor.initializer\n    );\n\n    assert(\n      `Expected passed resource to be a valid resource definition.`,\n      typeof resource === 'function' || (typeof resource === 'object' && resource !== null)\n    );\n\n    return {\n      get(this: object) {\n        const owner = getOwner(this);\n\n        assert(\n          `owner was not found on instance of ${this.constructor.name}. ` +\n            `Has it been linked up correctly with setOwner?` +\n            `If this error has occured in a framework-controlled class, something has gone wrong.`,\n          owner\n        );\n\n        assert(`Resource definition is invalid`, isResourceType(resource));\n\n        if (macroCondition(isTesting() || isDevelopingApp())) {\n          const cachedReplacements = ensureCaches(owner, REPLACEMENTS);\n\n          const replacement = cachedReplacements.get(resource);\n\n          if (replacement) {\n            resource = replacement;\n\n            assert(`Replacement Resource definition is invalid`, isResourceType(resource));\n          }\n        }\n\n        const caches = ensureCaches(owner);\n        let cache = caches.get(resource);\n\n        if (!cache) {\n          if ('type' in resource) {\n            assert(\n              `When using resources with @service(...), do not call .from() on class-based resources. ` +\n                `Resources used as services may not take arguments.`,\n              resource.type === 'function-based'\n            );\n\n            cache = invokeHelper(owner, resource);\n            caches.set(resource, cache);\n            associateDestroyableChild(owner, cache);\n          } else if ('from' in resource) {\n            /**\n             * We do a lot of lying internally to make TypeScript nice for consumers.\n             * But it does mean that we have to cast in our own code.\n             */\n            const { definition } = resource.from(() => []) as unknown as any;\n\n            cache = invokeHelper(owner, definition);\n            caches.set(resource, cache);\n            associateDestroyableChild(owner, cache);\n          }\n        }\n\n        return getValue(cache);\n      },\n    } as unknown as void /* thanks, TS. */;\n  };\n}\n\nfunction ensureCaches(owner: Owner, cache = __secret_service_cache__) {\n  let caches = cache.get(owner);\n\n  if (!caches) {\n    caches = new Map();\n    cache.set(owner, caches);\n  }\n\n  return caches;\n}\n\nfunction isResourceType(resource: unknown): resource is any {\n  // The internal representation of the passed resource will not match its type.\n  // A resource is always either a class definition, or the custom internal object.\n  // (See the helper managers for details)\n  return typeof resource === 'function' || (typeof resource === 'object' && resource !== null);\n}\n\ninterface RegisterOptions {\n  /**\n   * The original service to replace.\n   */\n  original: unknown;\n  /**\n   * The replacement service to use.\n   */\n  replacement: unknown;\n}\n\n/**\n *\n */\nexport function serviceOverride(owner: Owner, { original, replacement }: RegisterOptions) {\n  if (macroCondition(!isTesting() && !isDevelopingApp())) {\n    throw new Error(\n      '@service is experimental and `serviceOverride` is not available in production builds.'\n    );\n  }\n\n  const caches = ensureCaches(owner);\n\n  assert(`Original Resource definition is invalid`, isResourceType(original));\n  assert(`Replacement Resource definition is invalid`, isResourceType(replacement));\n\n  assert(`Cannot re-register service after it has been accessed.`, !caches.has(original));\n\n  const replacementCache = ensureCaches(owner, REPLACEMENTS);\n\n  replacementCache.set(original, replacement);\n}\n"],"names":["getOwner","compatOwner","__secret_service_cache__","WeakMap","REPLACEMENTS","service","resource","legacyServiceDecorator","_prototype","key","descriptor","assert","initializer","get","owner","constructor","name","isResourceType","macroCondition","isTesting","isDevelopingApp","cachedReplacements","ensureCaches","replacement","caches","cache","type","invokeHelper","set","associateDestroyableChild","definition","from","getValue","Map","serviceOverride","original","Error","has","replacementCache"],"mappings":"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"}